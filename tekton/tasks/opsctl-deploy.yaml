apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: opsctl-deploy
  namespace: test-workloads
spec:
  params:
    - name: chart
      type: string
    - name: ref
      type: string
  volumes:
  - name: kubeconfig
    secret:
      secretName: standup-kubeconfig
  workspaces:
  - name: cluster
    description: Cluster information is stored here.
  steps:
  - name: deploy
    image: quay.io/giantswarm/opsctl:1.29.0-00425306b6dc81715bed30e3ad1b2e117d54faaf
    volumeMounts:
      - name: kubeconfig
        mountPath: /etc/kubeconfig
    env:
      - name: KUBECONFIG
        value: /etc/kubeconfig/aws
      - name: OPSCTL_UNSAFE_FORCE_VERSION
        value: 1.29.1-dev
      - name: OPSCTL_GITHUB_TOKEN
        valueFrom:
          secretKeyRef:
            name: tityosbot-token-github
            key: oauth
    script: |
      #! /bin/sh
      env

      ref=""
      if [ -n "$(params.ref)" ]; then
        ref="@$(params.ref)"
      fi

      opsctl deploy \
      --use-kubeconfig \
      $(params.chart)$ref
