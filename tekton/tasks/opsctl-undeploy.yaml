apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: opsctl-undeploy
  namespace: test-workloads
spec:
  params:
    - name: chart
      type: string
    - name: kubeconfig
      type: string
  volumes:
  - name: kubeconfig
    secret:
      secretName: standup-kubeconfig
  workspaces:
  - name: cluster
    description: Cluster information is stored here.
  steps:
  - name: deploy
    image: quay.io/giantswarm/opsctl:1.30.0-fcacce17188954b2316c243fbebafaec82208cd1
    volumeMounts:
      - name: kubeconfig
        mountPath: /etc/kubeconfig
    env:
      - name: KUBECONFIG
        value: "/etc/kubeconfig/$(params.kubeconfig)"
      - name: OPSCTL_GITHUB_TOKEN
        valueFrom:
          secretKeyRef:
            name: tityosbot-token-github
            key: oauth
    script: |
      #! /bin/sh
      set -x
      opsctl undeploy \
      --use-kubeconfig \
      $(params.chart)
