apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: upgrade-cluster-capi-pure
  namespace: test-workloads
spec:
  resources:
  - name: source-repo
    type: git
  workspaces:
  - name: cluster
  params:
  - name: source-repo-name
    type: string
  - name: provider
    type: string
  - name: installation
    type: string
  - name: cluster-chart
    type: string
  - name: default-apps-chart
    type: string
  tasks:
  - name: create-cluster
    params:
    - name: source-repo-name
      value: $(params.source-repo-name)
    - name: provider
      value: $(params.provider)
    - name: installation
      value: $(params.installation)
    - name: cluster-chart
      value: $(params.cluster-chart)
    - name: default-apps-chart
      value: $(params.default-apps-chart)
    taskRef:
      name: create-cluster-capi-pure
    workspaces:
    - name: cluster
      workspace: cluster
    resources:
      inputs:
      - name: source-repo
        resource: source-repo

  - name: wait-for-ready
    runAfter: [create-cluster]
    timeout: 1h0m0s
    taskRef:
      name: wait-for-ready
    workspaces:
    - name: cluster
      workspace: cluster

  - name: update-cluster
    params:
    - name: source-repo-name
      value: $(params.source-repo-name)
    - name: provider
      value: $(params.provider)
    - name: installation
      value: $(params.installation)
    - name: cluster-chart
      value: $(params.cluster-chart)
    - name: default-apps-chart
      value: $(params.default-apps-chart)
    - name: released-version-only
      value: true
    taskRef:
      name: create-cluster-capi-pure
    workspaces:
    - name: cluster
      workspace: cluster
    resources:
      inputs:
      - name: source-repo
        resource: source-repo

  - name: wait-for-ready
    runAfter: [create-cluster]
    timeout: 1h0m0s
    taskRef:
      name: wait-for-ready
    workspaces:
    - name: cluster
      workspace: cluster
  - name: create-cluster
    params:
    - name: source-repo-name
      value: $(params.source-repo-name)
    - name: provider
      value: $(params.provider)
    - name: installation
      value: $(params.installation)
    - name: cluster-chart
      value: $(params.cluster-chart)
    - name: default-apps-chart
      value: $(params.default-apps-chart)
    taskRef:
      name: create-cluster-capi-pure
    workspaces:
    - name: cluster
      workspace: cluster
    resources:
      inputs:
      - name: source-repo
        resource: source-repo

  - name: wait-for-ready
    runAfter: [create-cluster]
    timeout: 1h0m0s
    taskRef:
      name: wait-for-ready
    workspaces:
    - name: cluster
      workspace: cluster
  - name: create-cluster
    params:
    - name: source-repo-name
      value: $(params.source-repo-name)
    - name: provider
      value: $(params.provider)
    - name: installation
      value: $(params.installation)
    - name: cluster-chart
      value: $(params.cluster-chart)
    - name: default-apps-chart
      value: $(params.default-apps-chart)
    taskRef:
      name: create-cluster-capi-pure
    workspaces:
    - name: cluster
      workspace: cluster
    resources:
      inputs:
      - name: source-repo
        resource: source-repo

  - name: wait-for-ready
    runAfter: [create-cluster]
    timeout: 1h0m0s
    taskRef:
      name: wait-for-ready
    workspaces:
    - name: cluster
      workspace: cluster

  finally:
  - name: cleanup
    taskRef:
      name: cleanup-capi-pure
    workspaces:
    - name: cluster
      workspace: cluster
